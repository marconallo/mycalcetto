{"ts":1343224443460,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\nif(!defined('INCLUDE_CHECK')) die('You are not allowed to execute this file directly');\n\nrequire_once 'user_access/connect.php';\nrequire_once 'user_access/functions.php';\n\nrequire_once 'script/log.php';\n$logDir=\"log\";\n$logFileName=\"debug\";\n$headerTitle=\"MyCalcetto\";\n$logMode=\"oneFile\"; //oneFile: each log instance goes to the same file ([logFileName].log) | oneFilePerLog: each log instance goes to a new file ([logFileName][logNumber].log\n$counterFile=\"debug.counter\";\n$logger=new Log($logDir,$logFileName,$headerTitle, $logMode, $counterFile);\n\nfunction cambiaPassword($user, $oldPass, $newPass){\n\n\t$conto=\"SELECT PASS FROM TZ_MEMBERS WHERE ID = '$user';\";\n\t$res = mysql_query($conto);\n\tif($riga = mysql_fetch_array($res)){\n\t\tif($riga['PASS'] == md5($oldPass)) { /*Vecchia Password confermata!*/\n\t\t\t$query=\"UPDATE TZ_MEMBERS SET PASS = '\".md5($newPass).\"' WHERE ID = '$user';\";\n\t\t\tif(mysql_query($query)){\n\t\t\t\techo \"<div class='success'>La tua password &egrave; stata aggiornata.</div>\";\n\t\t\t\techo \"</br><p>Torna alla <a href='userData.php'>pagina precedente</a>.</p>\";\n\t\t\t}else {\n\t\t\t\techo \"<div class='error'>Si &egrave; verificato un errore, riprova.</div>\";\n\t\t\t\techo \"</br><p>Torna alla <a href='userData.php'>pagina precedente</a>.</p>\";\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction getUser($username, $password){\n\tglobal $logger;\n\t$res = mysql_query(\"SELECT ID,USR,LEVEL,NAME FROM TZ_MEMBERS WHERE USR='$username' AND PASS='\".md5($password).\"'\");\n\tif ($res){\n\t\t$logger->logThis($logger->get_formatted_date().\"[LOGIN] Utente: \".$username);\n\t\treturn mysql_fetch_assoc($res);\n\t}\n\n}\n\nfunction getUserById($userid){\n\treturn mysql_fetch_assoc(mysql_query(\"SELECT * FROM TZ_MEMBERS WHERE ID='$userid';\"));\n}\n\nfunction getUserByIdAjax($userid){\n\t$row = mysql_fetch_assoc(mysql_query(\"SELECT * FROM TZ_MEMBERS WHERE ID='$userid';\"));\n\techo $row['ID'].\"|\".$row['USR'].\"|\".$row['NAME'].\"|\".$row['SURNAME'].\"|\".$row['EMAIL'].\"|\".$row['MOBILE'].\"|\".$row['LEVEL'];\n}\n\nfunction newUser($username, $password, $email, $name, $surname, $remoteAddress){\n\tglobal $logger;\n\t$query=\"INSERT INTO TZ_MEMBERS(usr,pass,name,surname,email,regIP,dt,level) VALUES('$username','\".md5($password).\"','$name','$surname','$email','$remoteAddress',NOW(),0);\";\n\tif (mysql_query($query)) {\n\t\t$message = '\n\t\t\t\t<html>\n\t\t\t\t<head>\n\t\t\t\t  <title>Conferma registrazione</title>\n\t\t\t\t</head>\n\t\t\t\t<body>\n\t\t\t\t  <p>Ciao '.$name.',<br />la registrazione si e\\' conclusa con successo.</p>\n\t\t\t\t  <p>La password che ti &egrave; stata assegnata &egrave;: <strong>'.$password.'</strong>; potrai cambiarla accedendo ai tuoi dati.</p>\n\t\t\t\t  <p><a href=\"http://mycalcetto.altervista.org\" target=\"_blank\">Collegati ora.</a></p>\n\t\t\t\t  <p>&nbsp;</p>\n\t\t\t\t  <p>Grazie per averci scelto!</p>\n\t\t\t\t  <p>Lo Staff di MyCalcetto</p>\n\t\t\t\t</body>\n\t\t\t\t</html>';\n\n\t\tsend_mail('MyCalcetto <mycalcetto@altervista.org>',$email,'MyCalcetto - Registrazione', $message);\n\t\t$logger->logThis($logger->get_formatted_date().\"[INFO] Nuovo utente registrato: \".$username);\n\t\treturn 0;\n\t} else {\n\t\treturn -1;\n\t}\n}\n\nfunction updateUser($id, $email, $name, $surname, $mobile, $level, $accept){\n\tif(!empty($level)){\n\t\t$levelString = \",LEVEL='$level'\";\n\t} else{\n\t\t$levelString = \"\";\n\t}\n\t//if(!empty($accept)){\n\t\t$acceptString = \",ACCEPT='$accept'\";\n\t//} else{\n\t//\t$acceptString = \"\";\n\t//}\n\t$query=\"UPDATE TZ_MEMBERS SET NAME='$name',SURNAME='$surname',EMAIL='$email',MOBILE='$mobile' $levelString $acceptString WHERE ID = '$id';\";\n\tif (mysql_query($query)) {\n\t\techo \"<div class='success'>I dati sono stati aggiornati.</div>\";\n\t\t//echo \"</br><p>Torna alla <a href='userData.php'>pagina precedente</a>.</p>\";\n\t}else {\n\t\techo \"<div class='error'>Si &egrave; verificato un errore, riprova.</div>\";\n\t\t//echo \"</br><p>Torna alla <a href='userData.php'>pagina precedente</a>.</p>\";\n\t}\n}\n\nfunction updatePassword($id, $username, $oldPassword, $newPassword){\n\t$query=\"UPDATE TZ_MEMBERS SET PASS='$newPassword' WHERE ID=$id AND USR='$username' AND PASS='$oldPassword';\";\n\tif (mysql_query($query)) {\n\t\techo \"<div class='success'>La password &egrave; stata cambiata.</div>\";\n\t\techo \"</br><p>Torna alla <a href='userData.php'>pagina precedente</a>.</p>\";\n\t}else {\n\t\techo \"<div class='error'>Si &egrave; verificato un errore, riprova.</div>\";\n\t\techo \"</br><p>Torna alla <a href='userData.php'>pagina precedente</a>.</p>\";\n\t}\n}\n\n\nfunction getUserByIdPartita($idPartita) {\n\t$res = mysql_query(\"SELECT U.ID,U.NAME,U.SURNAME,U.USR,U.EMAIL from PARTITA P, TZ_MEMBERS U where U.ID=P.ID AND P.ID='\".$idPartita.\"'\") or die(mysql_error());\n\treturn $res;\n}\n\nfunction visualizzaUtenti(){\n\t$query = \"SELECT ID, USR, NAME, SURNAME, EMAIL, MOBILE, LEVEL, ACCEPT from TZ_MEMBERS ORDER BY NAME ASC;\";\n\t$rs = mysql_query($query);\n\n\tif ($row = mysql_fetch_array($rs)){\n\t\techo \"<br />\";\n\t\techo \"<table class='table2'>\";\n\t\techo \"<thead><tr>\";\n\t\techo \"<th scope='col'>Username</th>\";\n\t\techo \"<th scope='col'>Nome</th>\";\n\t\techo \"<th scope='col'>Cognome</th>\";\n\t\techo \"<th scope='col'>E-Mail</th>\";\n\t\techo \"<th scope='col'>Cell.</th>\";\n\t\techo \"<th scope='col'>Livello</th>\";\n\t\techo \"<th scope='col'>Accetta</th>\";\n\t\tif (isset($_SESSION['level']) && $_SESSION['level']==9) {\n\t\t\techo \"<th scope='col'>Action</th>\";\n\t\t}\n\t\techo \"</tr></thead>\";\n\t\tdo\n\t\t{\n\t\t\t$userId=$row[\"ID\"];\n\t\t\t$username=$row[\"USR\"];\n\t\t\t$nome=$row[\"NAME\"];\n\t\t\t$cognome=$row[\"SURNAME\"];\n\t\t\t$email=$row[\"EMAIL\"];\n\t\t\t$mobile=$row[\"MOBILE\"];\n\t\t\t$level=$row[\"LEVEL\"];\n\t\t\t$accept=$row[\"ACCEPT\"];\n\n\t\t\techo \"<tbody>\";\n\t\t\techo \"<tr>\";\n\t\t\techo \"<td>$username</td>\";\n\t\t\techo \"<td>$nome</td>\";\n\t\t\techo \"<td>$cognome</td>\";\n\t\t\techo \"<td>$email</td>\";\n\t\t\techo \"<td>$mobile</td>\";\n\t\t\techo \"<td>$level</td>\";\n\t\t\techo \"<td>$accept</td>\";\n\n\t\t\tif (isset($_SESSION['level']) && $_SESSION['level']==9) {\n\t\t\t\techo \"<td>\";\n\t\t\t\techo \"<form id='modifica_user_$userId' method='post' action='user.php' style='float:left;'>\n\t\t\t \t\t<input type='hidden' name='id_user' value='$userId' />\n\t\t\t \t\t<input type='hidden' name='action' value='modifica' />\n\t\t\t \t\t<img class='cancella_img' src='img/Edit_24x24.png' alt='Modifica' title=\\\"Modifica i dati dell'utente\\\" onclick='modificaUtente($userId);'>\n\t\t\t \t\t</form> &nbsp;\";\n\t\t\t\techo \" &nbsp;<form id='cancella_user_$userId' method='post' action='user.php' style='float:right;'>\n\t\t\t \t\t<input type='hidden' name='id_user' value='$userId' />\n\t\t\t \t\t<input type='hidden' name='action' value='elimina' />\n\t\t\t \t\t<img class='cancella_img' src='img/Cancel_24x24.png' alt='Cancella' title=\\\"Elimina l'utente\\\" onclick='eliminaUtente($userId);'>\n\t\t\t \t\t</form>\";\n\t\t\t\techo \"</td>\";\n\t\t\t}\n\t\t\techo \"</tr>\";\n\t\t} while ($row = mysql_fetch_array($rs));\n\t\techo \"</tbody>\";\n\t\techo \"</table>\";\n\t} else {\n\t\techo \"<div class='info'>Non ci sono utenti!</div>\";\n\t}\n}\n\nfunction visualizzaUtente($idUser, $isAdmin){\n\n\tif ($isAdmin) {\n\t\t$disabled = \"\";\n\t\t$modUser = \"'modUserAdmin()'\";\n\t\t$usernameLabel = \"Username\";\n\t} else{\n\t\t$disabled = \"disabled='disabled'\";\n\t\t$modUser = \"'modUser()'\";\n\t\t$usernameLabel = \"Username (sola lettura)\";\n\t}\n\n\t$row = getUserById($idUser);\n\tif($row['USR'])\t{ // everything is OK\n\t\t$acceptCheck=\"\";\n\t\tif($row['ACCEPT'] == 1){\n\t\t\t$acceptCheck=\"checked=checked\";\n\t\t}\n\t\techo'\n\t\t\t\t\n\t\t\t<p></p>\n\t\t\t\t<table>\n\t\t\t\t<tr>\n\t\t\t\t\t<td>\n\t\t\t\t\t<fieldset>\n\t\t\t\t\t\t<legend>Modifica Dati</legend>\n\t\t\t\t\t\t<form class=\"form\" id=\"userForm\" action=\"user.php\" method=\"post\">\n\t\t\t\t\t\t\t<input type=\"hidden\" name=\"action\" value=\"updateUser\" />\n\t\t\t\t\t\t\t<input type=\"hidden\" name=\"id\" value=\"'.$row['ID'].'\" />\n\t\t\t\t\t\t\t<input type=\"hidden\" name=\"isAdmin\" value=\"'.$isAdmin.'\" />\n\t\t\t\t\t\t\t<p class=\"username\">\n\t\t\t\t\t\t\t\t<input type=\"text\" name=\"username\" id=\"username\" value=\"'.$row['USR'].'\" '.$disabled.' />\n\t\t\t\t\t\t\t\t<label for=\"username\">'.$usernameLabel.'</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p class=\"nome\">\n\t\t\t\t\t\t\t\t<input type=\"text\" name=\"nome\" id=\"nome\" value=\"'.$row['NAME'].'\" />\n\t\t\t\t\t\t\t\t<label for=\"campo\">Nome</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p class=\"cognome\">\n\t\t\t\t\t\t\t\t<input type=\"text\" name=\"cognome\" id=\"cognome\" value=\"'.$row['SURNAME'].'\" />\n\t\t\t\t\t\t\t\t<label for=\"cognome\">Cognome</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p class=\"email\">\n\t\t\t\t\t\t\t\t<input type=\"text\" name=\"email\" id=\"email\" value=\"'.$row['EMAIL'].'\" />\n\t\t\t\t\t\t\t\t<label for=\"email\">E-mail</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p class=\"cellulare\">\n\t\t\t\t\t\t\t\t<input type=\"text\" name=\"cellulare\" id=\"cellulare\" value=\"'.$row['MOBILE'].'\" />\n\t\t\t\t\t\t\t\t<label for=\"username\">Cellulare</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p class=\"accetta\">\n\t\t\t\t\t\t\t\t<input type=\"checkbox\" value=\"1\" name=\"accetta\" '.$acceptCheck.' />\n\t\t\t\t\t\t\t\t<label for=\"accetta\">Accetta Sempre</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t';\n\t\tif ($isAdmin) {\n\t\t\techo '\n\t\t\t\t\t\t\t<p class=\"level\">\n\t\t\t\t\t\t\t\t<input type=\"text\" name=\"level\" id=\"level\" value=\"'.$row['LEVEL'].'\" />\n\t\t\t\t\t\t\t\t<label for=\"level\">Livello</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t';\n\t\t}\n\n\t\techo '\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t<a onclick='.$modUser.' class=\"awesome medium blue\">Modifica</a>\n\t\t\t\t\t\t\t\t&nbsp;\n\t\t\t\t\t\t\t\t<a id=\"resetUserForm\" class=\"awesome medium blue\">Reset</a>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</fieldset>\n\t\t\t\t\t</td>\n\t\t';\n\n\t\tif (!$isAdmin) {\n\t\t\techo'\n\t\t\t\t\t<td>&nbsp;</td>\n\t\t\t\t\t<td>&nbsp;</td>\n\t\t\t\t\t<td style=\"vertical-align: top;\">\n\t\t\t\t\t<fieldset>\n\t\t\t\t\t\t<legend>Cambia Password</legend>\n\t\t\t\t\t\t<form class=\"form\" id=\"passForm\" action=\"user.php\" method=\"post\">\n\t\t\t\t\t\t\t<input type=\"hidden\" name=\"action\" value=\"updatePass\" />\n\t\t\t\t\t\t\t<input type=\"hidden\" name=\"username\" value=\"'.$row['USR'].'\" />\n\t\t\t\t\t\t\t<input type=\"hidden\" name=\"id\" value=\"'.$row['ID'].'\" />\n\t\t\t\t\t\t\t<p class=\"password\">\n\t\t\t\t\t\t\t\t<input type=\"password\" name=\"oldPassword\" id=\"oldPassword\" />\n\t\t\t\t\t\t\t\t<label for=\"username\">Vecchia Password</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p class=\"password\">\n\t\t\t\t\t\t\t\t<input type=\"password\" name=\"newPassword\" id=\"newPassword\" />\n\t\t\t\t\t\t\t\t<label for=\"newPassword\">Nuova Password</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p class=\"password\">\n\t\t\t\t\t\t\t\t<input type=\"password\" name=\"newPasswordConfirm\" id=\"newPasswordConfirm\" />\n\t\t\t\t\t\t\t\t<label for=\"newPasswordConfirm\">Conferma Nuova Password</label>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t<a onclick=\\'modPass();\\' class=\"awesome medium blue\">Modifica</a>\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</fieldset>\n\t\t\t\t\t</td>\n\t\t\t';\n\t\t}\n\t\techo'\n\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t';\n\t}\n}\n\nfunction eliminaUtente($idUser) {\n\t$query=\"DELETE FROM TZ_MEMBERS WHERE ID=$idUser;\";\n\tif (mysql_query($query)) {\n\t\techo \"<div class='success'>Utente eliminato!</div>\";\n\t\techo \"</br><p>Torna alla <a href='visualizzaUtenti.php'>pagina precedente</a>.</p>\";\n\t}else {\n\t\techo \"<div class='error'>Si &egrave; verificato un errore!</div>\";\n\t\techo \"</br><p>Torna alla <a href='visualizzaUtenti.php'>pagina precedente</a>.</p>\";\n\t}\n}\n?>"]],"start1":0,"start2":0,"length1":0,"length2":10531}]],"length":10531}
{"contributors":[],"silentsave":false,"ts":1343224486530,"patch":[[{"diffs":[[0,"',NOW(),"],[-1,"0"],[1,"1"],[0,");\";\n\tif"]],"start1":2204,"start2":2204,"length1":17,"length2":17}]],"length":10531,"saved":false}
{"contributors":[],"silentsave":false,"ts":1350981905639,"patch":[[{"diffs":[[0,"tCheck.'"],[1,"\" '.$disabled.'"],[0," />\n\t\t\t\t"]],"start1":8431,"start2":8431,"length1":16,"length2":31}]],"length":10546,"saved":false}
